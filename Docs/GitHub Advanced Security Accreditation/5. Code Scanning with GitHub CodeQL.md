1. Understand CodeQL and how it analyzes code.
    - Consists of three steps:
        - Preparing the code, by creating a CodeQL database
        - Running CodeQL queries against the database
        - Interpreting the results
    - Database creation:
        - CodeQL first extracts a single relational representation of each source file in the codebase
        - For compiled languages, extraction works by monitoring the build process and itincludes a syntatic data about the abstract syntax tree and semantic data about name binding and type information
        - For interpreted languages, extractor runs on the source code, resolving dependencies to give an accurate representation of the codebase
        - There is one extractor for each language supported by CodeQL
        - For multi-language codebases, databases are generated one language at a time
        - After extraction, all the data required for analysis is imported into a single directory, known as the CodeQL database
    - Query execution:
        - After database creation, one or more queries are executed against it
        - CodeQL queries are written in QL language
        - You can run the queries checked out from the CodeQL repo using the CodeQL for VS Code extension or the CodeQL CLI.
    - Query results:
        - Queries contain metadata properties that indicate how the results should be interpreted.
        - results are output for code review and triaging. 
        - In CodeQL for Visual Studio Code, interpreted query results are automatically displayed in the source code. 
        - You can output results generated by the CodeQL CLI into a number of different formats for use with different tools.



2. Understand QL, a unique logic programming language.
    - Analysis engine used to automate security checks
    - Variant analysis:
        - the process of using a known security vulnerability such as a seed to find similar problems in the code
        - Querying code using CodeQL is the most efficient way to perform variant analysis
    - CodeQL databases:
        - contain queryable data extracted from a codebase, for a single language at a particular point in time
        - contains a full hierarchical representation of the code, including representation of the abstract syntax tree, the data-flow graph, and the control-flow graph
        - Each language has its own database schema that defines the relations used to create a database
    - Query suites
        - Allows to pass multiple queries to CodeQl
        - No need to specify the path to each query individually
        - Definitions stored in a YAML file, with the `.qls` extension
        - a sequence of instructions where each instruction is a YAML mapping with (usually) as single key
    - Default query suites:
        - `code-scannig`: queries run by default in CodeQL code scanning on GitHub.
        - `security-extended`: queries from `code-scanning`, plus extra security queries with slightly lower precision and severity.
        - `security-and-quality`: queries from `code-scanning`, `security-extended`, plus extra maintainability and reliability queries.
    - Query Language (QL) packs:
        - Packs contain queries, libraries, query suites, and important metadata
        - CodeQL contains QL packs for C/C++, C#, Java, JavaScript, Python, and Ruby
        - for Go, repository contains a QL pack for Go analysis
        - Users are also able to make custom QL packs
    - QL pack structure:
        - Must contain a file called `qlpack.yml` in its root directory
        - Should be well orgaized:
            - Queries are organized into directories for specific categories.
            - Queries for specific products, libraries, and frameworks are organized into their own top-level directories.
            - There is a top-level directory named `<owner>/<language>` for query library (.qll) files. Within this directory, .qll files should be organized into subdirectories for specific categories.
        - An example of `qlpack.yml`:
            ```yml
            name: codeql/java-queries
            version: 0.0.6-dev
            groups: java
            suites: codeql-suites
            extractor: java
            defaultSuiteFile: codeql-suites/java-code-scanning.qls
            dependencies:
                codeql/java-all: "*"
                codeql/suite-helpers: "*"
            ```

3. Configure code scanning:
    - 4 ways:
        - CodeQL: GitHub Actions
        - CodeQL: in a third-party CI system
        - Third-party: GitHub Actions
        - Third-party: Generated externally and then uploaded to GitHub
    - There are two options for specifying which queries to run with CodeQl code scanning:
        - Using code scanning workflow
        - Using a custom configuration file
    - The options to specify the additional queries are:
        - `packs` to install one or more CodeQL query packs and run the default query suite for these packs.
        - `queries` to specify a single `.ql` file, a directory containing multiple `.ql` files, a `.qls` query suite definition file, or any combination.
    - It is possible to use both packs and queries in the same workflow.
    - GitHub don't recommend referencing quiry suites directly from the github/codeql repository, like `github/codeql/cpp/ql/src@main`. Such queries may not be complied with the same version of CodeQL as used for other queries, which could lead to errors during analysis.
    - Use CodeQL query packs:
        - To add one or more CodeQL query packs, add `with: packs:` entry within the `uses: github/codeql-action/init@v1` section of the workflow.
        - `GITHUB_TOKEN` environment variable is required in ordet to use packages that aren't publicly available.
        - An example:
            ```yml
            - uses: github/codeql-action/init@v1
              with:
                # Comma-separated list of packs to download
                packs: scope/pack1,scope/pack2@1.2.3,scope/pack3@~1.2.3
            ```
    - Use queries in QL packs:
        - To add one or more queries, add w `with: queries:` entry within the `uses: github/codeql-action/init@v1` section of the workflow.
        - If queries are in a private repository, use the `external-repository-token` parameter to specify a token that has access token that has access to check out the private repository.
        ```yml
        - uses: github/codeql-action/init@v1
          with:
            queries: COMMA-SEPARATED LIST OF PATHS
            # Optional. Provide a token to access queries stored in private repositories.
            external-repository-token: ${{ secrets.ACCESS_TOKEN }}
        ```
        - You can also specify query suites in the value of queries.
        - Query suites are collections of queries, usually grouped by purpose or language.
        - The following query suites are built into CodeQL code scanning:
            - `code-scanning`: queries run by default in CodeQL code scanning on GitHub.
            - `security-extended`: queries of lower severity and precision than the default queries
            - `security-and-quality`: queries from security-extended, plus maintainability and reliability queries.
    - Combining queries from a workflow file and a custom configuration file:
        - If you also use a configuration file for custom settings, any additional packs or queries specified in your workflow are used instead of those specified in the configuration file. If you want to run the combined set of additional packs or queries, prefix the value of packs or queries in the workflow with the `+` symbol:
        ```yml
        - uses: github/codeql-action/init@v1
          with:
            config-file: ./.github/codeql/codeql-config.yml
            queries: +security-and-quality,octo-org/python-qlpack/show_ifs.ql@main
            packs: +scope/pack1,scope/pack2@v1.2.3`
        ```
    - Additional queries in a custom configuration file:
        - In the workflow file, use the `config-file` paratemeter of the `init` action to specify the configuration file you want to use:
        ```yml
        - uses: github/codeql-action/init@v1
          with:
            config-file: ./.github/codeql/codeql-config.yml
        ```
        - Configuration file can be located within the repository or in an external repository.
        - In order to reference configuration file located in external repository, use `OWNER/REPOSITORY/FILENAME@BRANCH` syntax. For example: `octo-org/shared/codeql-config.yml@main`
        - If configuration is located in an external private repository, use `external-repository-token` parameter of the `init` action to specify a token that has access to the private repository.
        ```yml
        - uses: github/codeql-action/init@v1
          with:
            external-repository-token: ${{ secrets.ACCESS_TOKEN }}
        ```
    - Specify CodeQL query packs in custom configuration files:
        - Query can be specified in an array:
        ```yml
        packs:
          # Use the latest version of 'pack1' published by 'scope'
          - scope/pack1
          # Use version 1.23 of 'pack2'
          - scope/pack2@v1.2.3
          # Use the latest version of 'pack3' compatible with 1.23
          - scope/pack3@~1.2.3
        ```
        - If workflow generates more than one CodeQL database, you can specify any CodeQL query packs to run in a custom configuration file using a nested map of packs
        ```yml
        packs:
          # Use these packs for JavaScript analysis
          javascript:
            - scope/js-pack1
            - scope/js-pack2
          # Use these packs for Java analysis
          java:
            - scope/java-pack1
            - scope/java-pack2@v1.0.0
        ```
    - Specify additional queries in custom configuration:
        - Can be specified in a queries array
        - Each element of array contains a uses parameter with a value that identifies a single query file, a directory containing query files, or a query suite definition:
        ```yml
        name: "My CodeQL config"

        disable-default-queries: true

        queries:
          - name: Use an in-repository QL pack (run queries in the my-queries directory)
            uses: ./my-queries
          - name: Use an external JavaScript QL pack (run queries from an external repo)
            uses: octo-org/javascript-qlpack@main
          - name: Use an external query (run a single query from an external QL pack)
            uses: octo-org/python-qlpack/show_ifs.ql@main
          - name: Use a query suite file (run queries from a query suite in this repo)
            uses: ./codeql-qlpacks/complex-python-qlpack/rootAndBar.qls

        paths:
          - src
        paths-ignore:
          - src/node_modules
          - '**/*.test.js'
        ```
    - Disabling default queries:
        - To disable default queries, use `disable-default-queries: true` syntax.
        - This syntax should be used to construct a custom query suite that excludes a particular rule. (to avoid having all of the queries run twice)
    - Specify directories to scan:
        - To specify directories to scan, use `paths` and `paths-ignore` parameters.
        ```yml
        paths:
          - src
        paths-ignore:
          - src/node_modules
          - '**/*.test.js'
        ```
        - The paths and paths-ignore keywords, used in the context of the code scanning configuration file, should not be confused with the same keywords when used for `on.<push|pull_request>.paths` in a workflow. When they're used to modify `on.<push|pull_request>` in a workflow, they determine whether the actions will be run when someone modifies code in the specified directories.
        - The filter pattern characters ?, +, [, ], and ! aren't supported and will be matched literally.
        - ** characters can only be at the start or end of a line, or surrounded by slashes, and you can't mix ** and other characters. For example: `foo/**`, `**/foo`, and `foo/**/bar` are all allowed syntax, but **foo isn't. However ,you can use single stars along with other characters, as shown in the example. You'll need to quote anything that contains a * character.

4. Using CodeQL CLI:
    - CodeQL CLI commands:
        - `database create`: to create a CodeQL database
        - `database analyze`: to run queries against a database
        - `github upload-results`: to upload results (SARIF files) to GitHub
        - `--help`: to get help command-line options
    - Create CodeQL databases to analyze:
        - Checkout the code to analyze > set up the environment of the codebase > find the build command > run `codeql database create` command:
            - to create one CodeQL database for a single supported language, use:
            ```bash
            codeql database create <database> --command<build> --language=<language-identifier>
            ```
            - to create one CodeQL database per language for multiple supported languages, use:
            ```bash
            codeql database create <database> --command<build> \
            --db-cluster --language=<language-identifier>,<language-identifier>
            ```
            - If you use a containerized build, you need to run the CodeQL CLI inside the container where you build task takes place.

5. CodeQL and matrix:
    - Recommended by GitHub due to the performance benefits of parallelizing builds:
    ```yml
    jobs:
      analyze:
        name: Analyze
        ...
        strategy:
          fail-fast: false
          matrix:
            language: ['javascript', 'python']
    ```
    - If workflow doesn't contain a matrix called `language`, then CodeQL will run analysis sequentially. 
    - If languages are not specified in the workflow, CodeQL detects and attempts to analyze any supported languages in the repository.
    - In order to analyze specific languages without using a matrix, tou can use the languages parameter under the `init` action:
    ```yml
    - uses: github/codeql-action/init@v1
      with:
        languages: cpp, csharp, python
    ```
    - If the C/C++, C#, or Java code in your repository has a non-standard build process, autobuild may fail. You will need to remove the `autobuild` step from the workflow, and manually add build steps.
    ```yml
    - if: matrix.language == 'cpp' || matrix.language == 'csharp'
      name: Autobuild
      uses: github/codeql-action/autobuild@v1

    - if: matrix.language == 'java'
      name: Build Java
      run: |
        make bootstrap
        make release
    ```
